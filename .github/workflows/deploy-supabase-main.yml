name: deploy-supabase

on:
  push:
    branches:
      - staging
      - main
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'scripts/ci/supabase-verify.sql'

concurrency:
  group: deploy-supabase-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    name: deploy-supabase-${{ github.ref_name }}
    runs-on: ubuntu-latest
    env:
      # Production secrets (main)
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      # Staging secrets (staging)
      SUPABASE_ACCESS_TOKEN_STAGING: ${{ secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
      SUPABASE_PROJECT_REF_STAGING: ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
      SUPABASE_DB_PASSWORD_STAGING: ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}
      SUPABASE_DB_URL_STAGING: ${{ secrets.SUPABASE_DB_URL_STAGING }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Supabase target
        run: |
          set -euo pipefail

          if [ "${GITHUB_REF_NAME}" = "staging" ]; then
            DEPLOY_ENV="staging"
            ACCESS_TOKEN="${SUPABASE_ACCESS_TOKEN_STAGING:-}"
            PROJECT_REF="${SUPABASE_PROJECT_REF_STAGING:-}"
            DB_PASSWORD="${SUPABASE_DB_PASSWORD_STAGING:-}"
            DB_URL="${SUPABASE_DB_URL_STAGING:-}"
          elif [ "${GITHUB_REF_NAME}" = "main" ]; then
            DEPLOY_ENV="production"
            ACCESS_TOKEN="${SUPABASE_ACCESS_TOKEN:-}"
            PROJECT_REF="${SUPABASE_PROJECT_REF:-}"
            DB_PASSWORD="${SUPABASE_DB_PASSWORD:-}"
            DB_URL="${SUPABASE_DB_URL:-}"
          else
            echo "Unsupported branch for deploy: ${GITHUB_REF_NAME}"
            exit 1
          fi

          echo "DEPLOY_ENV=${DEPLOY_ENV}" >> "$GITHUB_ENV"

          {
            echo "SUPABASE_ACCESS_TOKEN<<EOF"
            printf '%s\n' "$ACCESS_TOKEN"
            echo "EOF"
            echo "SUPABASE_PROJECT_REF<<EOF"
            printf '%s\n' "$PROJECT_REF"
            echo "EOF"
            echo "SUPABASE_DB_PASSWORD<<EOF"
            printf '%s\n' "$DB_PASSWORD"
            echo "EOF"
            echo "SUPABASE_DB_URL<<EOF"
            printf '%s\n' "$DB_URL"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Validate required secrets
        run: |
          set -euo pipefail
          echo "Deploy environment: ${DEPLOY_ENV}"
          missing=0
          for key in SUPABASE_ACCESS_TOKEN SUPABASE_PROJECT_REF SUPABASE_DB_URL; do
            if [ -z "${!key:-}" ]; then
              echo "Missing required secret: $key for ${DEPLOY_ENV}"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate Supabase CLI
        run: supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Deploy migrations
        run: |
          set -euo pipefail
          if [ -n "${SUPABASE_DB_PASSWORD:-}" ]; then
            supabase db push --linked --include-all --password "$SUPABASE_DB_PASSWORD"
          else
            supabase db push --linked --include-all
          fi

      - name: Detect changed edge functions
        id: changed-functions
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-list --max-parents=0 HEAD)"
          fi

          mapfile -t names < <(
            git diff --name-only "$BEFORE" "$AFTER" -- supabase/functions \
              | awk -F/ '/^supabase\/functions\// { if ($3 != "_shared" && $3 != "") print $3 }' \
              | sort -u
          )

          if [ "${#names[@]}" -eq 0 ]; then
            echo "none=true" >> "$GITHUB_OUTPUT"
            echo "No changed edge functions in this push."
            exit 0
          fi

          printf 'functions=%s\n' "${names[*]}" >> "$GITHUB_OUTPUT"
          echo "Changed functions: ${names[*]}"

      - name: Deploy changed edge functions
        if: steps.changed-functions.outputs.none != 'true'
        run: |
          set -euo pipefail
          for fn in ${{ steps.changed-functions.outputs.functions }}; do
            echo "Deploying edge function: $fn"
            supabase functions deploy "$fn" --project-ref "$SUPABASE_PROJECT_REF"
          done

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Post-deploy verification (read-only)
        run: psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 -f scripts/ci/supabase-verify.sql
