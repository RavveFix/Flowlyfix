name: ci-pr

on:
  pull_request:
    branches:
      - staging
      - main

concurrency:
  group: ci-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  label-policy:
    name: label-policy
    runs-on: ubuntu-latest
    steps:
      - name: Validate required labels
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = new Set((pr.labels || []).map((l) => l.name));
            const requiredTracks = ['agent-track-1', 'agent-track-2', 'agent-track-3'];

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changed = files.map((f) => f.filename);
            const touchesDb = changed.some((f) => f.startsWith('supabase/migrations/') || f.startsWith('supabase/functions/'));
            const touchesHighRisk = changed.some((f) => {
              const lower = f.toLowerCase();
              return (
                lower.startsWith('src/features/auth/') ||
                lower.startsWith('src/shared/lib/supabase/') ||
                lower.includes('rls') ||
                lower.includes('policy') ||
                lower.includes('permission') ||
                lower.includes('auth')
              );
            });

            const errors = [];
            if (!requiredTracks.some((track) => labels.has(track))) {
              errors.push(`Missing one required lane label: ${requiredTracks.join(', ')}`);
            }
            if (touchesDb && !labels.has('db-change')) {
              errors.push('This PR changes supabase migrations/functions and must include label: db-change');
            }
            if (touchesHighRisk && !labels.has('risk-high')) {
              errors.push('This PR touches auth/rls/policy-sensitive code and must include label: risk-high');
            }

            if (errors.length > 0) {
              core.setFailed(errors.join('\n'));
            } else {
              core.info('Label policy passed.');
            }

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Typecheck
        run: npm run typecheck

  build:
    name: build
    runs-on: ubuntu-latest
    needs:
      - typecheck
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      VITE_DEMO_MODE: "false"
      VITE_CANONICAL_DEV_ORIGIN: http://localhost:3000
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: error

  smoke-auth:
    name: smoke-auth
    runs-on: ubuntu-latest
    needs:
      - build
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      VITE_DEMO_MODE: "false"
      VITE_CANONICAL_DEV_ORIGIN: http://localhost:3000
      PLAYWRIGHT_BASE_URL: http://localhost:3000
      E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
      E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Start preview server
        run: |
          npx vite preview --host 0.0.0.0 --port 3000 --strictPort > /tmp/preview.log 2>&1 &
          echo $! > /tmp/preview.pid
      - name: Wait for preview
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3000 > /dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "Preview server failed to start"
          cat /tmp/preview.log || true
          exit 1
      - name: Smoke auth suite
        run: npm run smoke:auth
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-auth-${{ github.run_id }}
          path: |
            test-results
            playwright-report
          if-no-files-found: ignore
      - name: Stop preview server
        if: always()
        run: |
          if [ -f /tmp/preview.pid ]; then
            kill "$(cat /tmp/preview.pid)" || true
          fi

  smoke-admin:
    name: smoke-admin
    runs-on: ubuntu-latest
    needs:
      - build
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      VITE_DEMO_MODE: "false"
      VITE_CANONICAL_DEV_ORIGIN: http://localhost:3000
      PLAYWRIGHT_BASE_URL: http://localhost:3000
      E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
      E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Start preview server
        run: |
          npx vite preview --host 0.0.0.0 --port 3000 --strictPort > /tmp/preview.log 2>&1 &
          echo $! > /tmp/preview.pid
      - name: Wait for preview
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3000 > /dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "Preview server failed to start"
          cat /tmp/preview.log || true
          exit 1
      - name: Smoke admin suite
        run: npm run smoke:admin
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-admin-${{ github.run_id }}
          path: |
            test-results
            playwright-report
          if-no-files-found: ignore
      - name: Stop preview server
        if: always()
        run: |
          if [ -f /tmp/preview.pid ]; then
            kill "$(cat /tmp/preview.pid)" || true
          fi
